#!/usr/bin/python3
import os, sys, argparse
from utils import *

parser = argparse.ArgumentParser(description=__doc__)
parser.add_argument('--debug', action="store_true")
args = parser.parse_args()

print ("ver -- Versioning Easily Remembered")

def update(pull = True):
    out, good = git("submodule update", show=True, debug=args.debug)
    out, good = git("reset", show=False, debug=args.debug)
    if out.find("Unstaged changes after reset") == 0:
        print ("The following files have unsaved changes:")
        lines = out.split("\n")
        for line in lines:
            if line[0:1] == "M":
                print ("  "+line[2:])
        if input("Go ahead and overwrite these files?").lower()[:1] != "y":
            print ("update incomplete")
            exit(); 0/0
    out, good = git("reset --hard", show=False, debug=args.debug)
    if pull:
        out, good = git("pull", show=True, debug=args.debug)
    subs = get_subs()
    for sub in subs:
        print ("Processing", sub)
        path = os.path.abspath(".")
        os.chdir(sub)
        # os.system("pwd")
        update(pull = False)
        os.chdir(path)

#cd_to_root()

print ("Processing root project")
update()

